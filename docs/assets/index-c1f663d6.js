var qt=Object.defineProperty;var Bt=(r,t,e)=>t in r?qt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var l=(r,t,e)=>(Bt(r,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();function h(r){return r!=null&&typeof r=="object"&&r["@@functional/placeholder"]===!0}function y(r){return function t(e){return arguments.length===0||h(e)?t:r.apply(this,arguments)}}function d(r){return function t(e,n){switch(arguments.length){case 0:return t;case 1:return h(e)?t:y(function(o){return r(e,o)});default:return h(e)&&h(n)?t:h(e)?y(function(o){return r(o,n)}):h(n)?y(function(o){return r(e,o)}):r(e,n)}}}function q(r,t){switch(r){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,o){return t.apply(this,arguments)};case 4:return function(e,n,o,i){return t.apply(this,arguments)};case 5:return function(e,n,o,i,a){return t.apply(this,arguments)};case 6:return function(e,n,o,i,a,s){return t.apply(this,arguments)};case 7:return function(e,n,o,i,a,s,c){return t.apply(this,arguments)};case 8:return function(e,n,o,i,a,s,c,f){return t.apply(this,arguments)};case 9:return function(e,n,o,i,a,s,c,f,p){return t.apply(this,arguments)};case 10:return function(e,n,o,i,a,s,c,f,p,m){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function yt(r,t,e){return function(){for(var n=[],o=0,i=r,a=0;a<t.length||o<arguments.length;){var s;a<t.length&&(!h(t[a])||o>=arguments.length)?s=t[a]:(s=arguments[o],o+=1),n[a]=s,h(s)||(i-=1),a+=1}return i<=0?e.apply(this,n):q(i,yt(r,n,e))}}var mt=d(function(t,e){return t===1?y(e):q(t,yt(t,[],e))});function wt(r){return function t(e,n,o){switch(arguments.length){case 0:return t;case 1:return h(e)?t:d(function(i,a){return r(e,i,a)});case 2:return h(e)&&h(n)?t:h(e)?d(function(i,a){return r(i,n,a)}):h(n)?d(function(i,a){return r(e,i,a)}):y(function(i){return r(e,n,i)});default:return h(e)&&h(n)&&h(o)?t:h(e)&&h(n)?d(function(i,a){return r(i,a,o)}):h(e)&&h(o)?d(function(i,a){return r(i,n,a)}):h(n)&&h(o)?d(function(i,a){return r(e,i,a)}):h(e)?y(function(i){return r(i,n,o)}):h(n)?y(function(i){return r(e,i,o)}):h(o)?y(function(i){return r(e,n,i)}):r(e,n,o)}}}const j=Array.isArray||function(t){return t!=null&&t.length>=0&&Object.prototype.toString.call(t)==="[object Array]"};function Nt(r){return r!=null&&typeof r["@@transducer/step"]=="function"}function vt(r,t,e){return function(){if(arguments.length===0)return e();var n=arguments[arguments.length-1];if(!j(n)){for(var o=0;o<r.length;){if(typeof n[r[o]]=="function")return n[r[o]].apply(n,Array.prototype.slice.call(arguments,0,-1));o+=1}if(Nt(n)){var i=t.apply(null,Array.prototype.slice.call(arguments,0,-1));return i(n)}}return e.apply(this,arguments)}}const R={init:function(){return this.xf["@@transducer/init"]()},result:function(r){return this.xf["@@transducer/result"](r)}};function H(r){for(var t=[],e;!(e=r.next()).done;)t.push(e.value);return t}function Y(r,t,e){for(var n=0,o=e.length;n<o;){if(r(t,e[n]))return!0;n+=1}return!1}function Ft(r){var t=String(r).match(/^function (\w*)/);return t==null?"":t[1]}function E(r,t){return Object.prototype.hasOwnProperty.call(t,r)}function Wt(r,t){return r===t?r!==0||1/r===1/t:r!==r&&t!==t}const F=typeof Object.is=="function"?Object.is:Wt;var Z=Object.prototype.toString,_t=function(){return Z.call(arguments)==="[object Arguments]"?function(t){return Z.call(t)==="[object Arguments]"}:function(t){return E("callee",t)}}(),$t=!{toString:null}.propertyIsEnumerable("toString"),K=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],J=function(){return arguments.propertyIsEnumerable("length")}(),Vt=function(t,e){for(var n=0;n<t.length;){if(t[n]===e)return!0;n+=1}return!1},O=y(typeof Object.keys=="function"&&!J?function(t){return Object(t)!==t?[]:Object.keys(t)}:function(t){if(Object(t)!==t)return[];var e,n,o=[],i=J&&_t(t);for(e in t)E(e,t)&&(!i||e!=="length")&&(o[o.length]=e);if($t)for(n=K.length-1;n>=0;)e=K[n],E(e,t)&&!Vt(o,e)&&(o[o.length]=e),n-=1;return o}),tt=y(function(t){return t===null?"Null":t===void 0?"Undefined":Object.prototype.toString.call(t).slice(8,-1)});function et(r,t,e,n){var o=H(r),i=H(t);function a(s,c){return V(s,c,e.slice(),n.slice())}return!Y(function(s,c){return!Y(a,c,s)},i,o)}function V(r,t,e,n){if(F(r,t))return!0;var o=tt(r);if(o!==tt(t))return!1;if(typeof r["fantasy-land/equals"]=="function"||typeof t["fantasy-land/equals"]=="function")return typeof r["fantasy-land/equals"]=="function"&&r["fantasy-land/equals"](t)&&typeof t["fantasy-land/equals"]=="function"&&t["fantasy-land/equals"](r);if(typeof r.equals=="function"||typeof t.equals=="function")return typeof r.equals=="function"&&r.equals(t)&&typeof t.equals=="function"&&t.equals(r);switch(o){case"Arguments":case"Array":case"Object":if(typeof r.constructor=="function"&&Ft(r.constructor)==="Promise")return r===t;break;case"Boolean":case"Number":case"String":if(!(typeof r==typeof t&&F(r.valueOf(),t.valueOf())))return!1;break;case"Date":if(!F(r.valueOf(),t.valueOf()))return!1;break;case"Error":return r.name===t.name&&r.message===t.message;case"RegExp":if(!(r.source===t.source&&r.global===t.global&&r.ignoreCase===t.ignoreCase&&r.multiline===t.multiline&&r.sticky===t.sticky&&r.unicode===t.unicode))return!1;break}for(var i=e.length-1;i>=0;){if(e[i]===r)return n[i]===t;i-=1}switch(o){case"Map":return r.size!==t.size?!1:et(r.entries(),t.entries(),e.concat([r]),n.concat([t]));case"Set":return r.size!==t.size?!1:et(r.values(),t.values(),e.concat([r]),n.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var a=O(r);if(a.length!==O(t).length)return!1;var s=e.concat([r]),c=n.concat([t]);for(i=a.length-1;i>=0;){var f=a[i];if(!(E(f,t)&&V(t[f],r[f],s,c)))return!1;i-=1}return!0}var zt=d(function(t,e){return V(t,e,[],[])});function Dt(r,t,e){var n,o;if(typeof r.indexOf=="function")switch(typeof t){case"number":if(t===0){for(n=1/t;e<r.length;){if(o=r[e],o===0&&1/o===n)return e;e+=1}return-1}else if(t!==t){for(;e<r.length;){if(o=r[e],typeof o=="number"&&o!==o)return e;e+=1}return-1}return r.indexOf(t,e);case"string":case"boolean":case"function":case"undefined":return r.indexOf(t,e);case"object":if(t===null)return r.indexOf(t,e)}for(;e<r.length;){if(zt(r[e],t))return e;e+=1}return-1}function Qt(r,t){return Dt(t,r,0)>=0}function x(r,t){for(var e=0,n=t.length,o=Array(n);e<n;)o[e]=r(t[e]),e+=1;return o}function W(r){var t=r.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0");return'"'+t.replace(/"/g,'\\"')+'"'}var T=function(t){return(t<10?"0":"")+t},Ut=typeof Date.prototype.toISOString=="function"?function(t){return t.toISOString()}:function(t){return t.getUTCFullYear()+"-"+T(t.getUTCMonth()+1)+"-"+T(t.getUTCDate())+"T"+T(t.getUTCHours())+":"+T(t.getUTCMinutes())+":"+T(t.getUTCSeconds())+"."+(t.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};function Xt(r){return function(){return!r.apply(this,arguments)}}function Ot(r,t,e){for(var n=0,o=e.length;n<o;)t=r(t,e[n]),n+=1;return t}function Gt(r,t){for(var e=0,n=t.length,o=[];e<n;)r(t[e])&&(o[o.length]=t[e]),e+=1;return o}function Ht(r){return Object.prototype.toString.call(r)==="[object Object]"}var Yt=function(){function r(t,e){this.xf=e,this.f=t}return r.prototype["@@transducer/init"]=R.init,r.prototype["@@transducer/result"]=R.result,r.prototype["@@transducer/step"]=function(t,e){return this.f(e)?this.xf["@@transducer/step"](t,e):t},r}();function Zt(r){return function(t){return new Yt(r,t)}}var Kt=d(vt(["fantasy-land/filter","filter"],Zt,function(r,t){return Ht(t)?Ot(function(e,n){return r(t[n])&&(e[n]=t[n]),e},{},O(t)):Gt(r,t)}));const z=Kt;var At=d(function(t,e){return z(Xt(t),e)});function St(r,t){var e=function(a){var s=t.concat([r]);return Qt(a,s)?"<Circular>":St(a,s)},n=function(i,a){return x(function(s){return W(s)+": "+e(i[s])},a.slice().sort())};switch(Object.prototype.toString.call(r)){case"[object Arguments]":return"(function() { return arguments; }("+x(e,r).join(", ")+"))";case"[object Array]":return"["+x(e,r).concat(n(r,At(function(i){return/^\d+$/.test(i)},O(r)))).join(", ")+"]";case"[object Boolean]":return typeof r=="object"?"new Boolean("+e(r.valueOf())+")":r.toString();case"[object Date]":return"new Date("+(isNaN(r.valueOf())?e(NaN):W(Ut(r)))+")";case"[object Map]":return"new Map("+e(Array.from(r))+")";case"[object Null]":return"null";case"[object Number]":return typeof r=="object"?"new Number("+e(r.valueOf())+")":1/r===-1/0?"-0":r.toString(10);case"[object Set]":return"new Set("+e(Array.from(r).sort())+")";case"[object String]":return typeof r=="object"?"new String("+e(r.valueOf())+")":W(r);case"[object Undefined]":return"undefined";default:if(typeof r.toString=="function"){var o=r.toString();if(o!=="[object Object]")return o}return"{"+n(r,O(r)).join(", ")+"}"}}var M=y(function(t){return St(t,[])}),Jt=d(function(t,e){if(t===e)return e;function n(c,f){if(c>f!=f>c)return f>c?f:c}var o=n(t,e);if(o!==void 0)return o;var i=n(typeof t,typeof e);if(i!==void 0)return i===typeof t?t:e;var a=M(t),s=n(a,M(e));return s!==void 0&&s===a?t:e}),te=function(){function r(t,e){this.xf=e,this.f=t}return r.prototype["@@transducer/init"]=R.init,r.prototype["@@transducer/result"]=R.result,r.prototype["@@transducer/step"]=function(t,e){return this.xf["@@transducer/step"](t,this.f(e))},r}(),ee=function(t){return function(e){return new te(t,e)}},re=d(vt(["fantasy-land/map","map"],ee,function(t,e){switch(Object.prototype.toString.call(e)){case"[object Function]":return mt(e.length,function(){return t.call(this,e.apply(this,arguments))});case"[object Object]":return Ot(function(n,o){return n[o]=t(e[o]),n},{},O(e));default:return x(t,e)}}));const ne=Number.isInteger||function(t){return t<<0===t};function P(r){return Object.prototype.toString.call(r)==="[object String]"}var oe=d(function(t,e){var n=t<0?e.length+t:t;return P(e)?e.charAt(n):e[n]}),ie=d(function(t,e){if(e!=null)return ne(t)?oe(t,e):e[t]}),ae=d(function(t,e){return re(ie(t),e)}),bt=y(function(t){return j(t)?!0:!t||typeof t!="object"||P(t)?!1:t.length===0?!0:t.length>0?t.hasOwnProperty(0)&&t.hasOwnProperty(t.length-1):!1}),rt=typeof Symbol<"u"?Symbol.iterator:"@@iterator";function se(r,t,e){return function(o,i,a){if(bt(a))return r(o,i,a);if(a==null)return i;if(typeof a["fantasy-land/reduce"]=="function")return t(o,i,a,"fantasy-land/reduce");if(a[rt]!=null)return e(o,i,a[rt]());if(typeof a.next=="function")return e(o,i,a);if(typeof a.reduce=="function")return t(o,i,a,"reduce");throw new TypeError("reduce: list must be array or iterable")}}function ue(r,t,e){for(var n=0,o=e.length;n<o;){if(t=r["@@transducer/step"](t,e[n]),t&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}n+=1}return r["@@transducer/result"](t)}var le=d(function(t,e){return q(t.length,function(){return t.apply(e,arguments)})});function ce(r,t,e){for(var n=e.next();!n.done;){if(t=r["@@transducer/step"](t,n.value),t&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}n=e.next()}return r["@@transducer/result"](t)}function fe(r,t,e,n){return r["@@transducer/result"](e[n](le(r["@@transducer/step"],r),t))}var pe=se(ue,fe,ce),he=function(){function r(t){this.f=t}return r.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},r.prototype["@@transducer/result"]=function(t){return t},r.prototype["@@transducer/step"]=function(t,e){return this.f(t,e)},r}();function de(r){return new he(r)}var ge=wt(function(r,t,e){return pe(typeof r=="function"?de(r):r,t,e)});const D=ge;function nt(r){var t=Object.prototype.toString.call(r);return t==="[object Function]"||t==="[object AsyncFunction]"||t==="[object GeneratorFunction]"||t==="[object AsyncGeneratorFunction]"}function ye(r){return function t(e){for(var n,o,i,a=[],s=0,c=e.length;s<c;){if(bt(e[s]))for(n=r?t(e[s]):e[s],i=0,o=n.length;i<o;)a[a.length]=n[i],i+=1;else a[a.length]=e[s];s+=1}return a}}function me(r,t){return function(){return t.call(this,r.apply(this,arguments))}}function Tt(r,t){return function(){var e=arguments.length;if(e===0)return t();var n=arguments[e-1];return j(n)||typeof n[r]!="function"?t.apply(this,arguments):n[r].apply(n,Array.prototype.slice.call(arguments,0,e-1))}}var we=wt(Tt("slice",function(t,e,n){return Array.prototype.slice.call(n,t,e)})),ve=y(Tt("tail",we(1,1/0)));const Oe=ve;function xt(){if(arguments.length===0)throw new Error("pipe requires at least one argument");return q(arguments[0].length,D(me,arguments[0],Oe(arguments)))}function Ae(r){return r}var Se=y(Ae);const ot=Se;var be=d(function(t,e){if(j(t)){if(j(e))return t.concat(e);throw new TypeError(M(e)+" is not an array")}if(P(t)){if(P(e))return t+e;throw new TypeError(M(e)+" is not a string")}if(t!=null&&nt(t["fantasy-land/concat"]))return t["fantasy-land/concat"](e);if(t!=null&&nt(t.concat))return t.concat(e);throw new TypeError(M(t)+' does not have a method named "concat" or "fantasy-land/concat"')});const Mt=be;var Te=d(function(t,e){return mt(D(Jt,0,ae("length",e)),function(){var n=arguments,o=this;return t.apply(o,x(function(i){return i.apply(o,n)},e))})}),xe=y(ye(!0));const Me=xe;var Le=y(function(t){for(var e=O(t),n=e.length,o=0,i={};o<n;){var a=e[o];i[t[a]]=a,o+=1}return i});const je=Le;var Ce=y(function(t){return Te(function(){return Array.prototype.slice.call(arguments,0)},t)});const Ie=Ce;function it(r){return Object.prototype.toString.call(r)==="[object Number]"}var Re=Ie([z,At]);const Ee=Re;var Pe=d(function(t,e){if(!(it(t)&&it(e)))throw new TypeError("Both arguments to range must be numbers");for(var n=[],o=t;o<e;)n.push(o),o+=1;return n});const at=Pe;let A=Object,st=(r,t,e)=>A.freeze(A.assign(A.seal(A.assign(A.create(r),t)),e));class w{static create(t){return st(this.prototype,new this(w),t)}constructor(t){if(t!==w)throw new Error(`Use ${this.constructor.name}.create(...) instead of new operator`)}copy(t){return st(A.getPrototypeOf(this),this,t)}equals(t){for(let e in this){let n=this[e],o=t[e];if(n!==o&&(n==null||o==null||(n instanceof w&&o instanceof w?!n.equals(o):n.valueOf()!==o.valueOf())))return!1}return!0}}const g=class extends w{constructor(){super(...arguments);l(this,"x",0);l(this,"y",0)}static of(e,n){if(n!==void 0)return g.create({x:e,y:n});if(Array.isArray(e))return g.create({x:e[0],y:e[1]});if("x"in e&&"y"in e)return g.create({x:e.x,y:e.y});throw console.error("Invalid arguments to Point.of: ",e,n),new Error(`Invalid argument(s) to Point.of: ${e}, ${n}`)}add(e){return g.create({x:this.x+e.x,y:this.y+e.y})}subtract(e){return g.create({x:this.x-e.x,y:this.y-e.y})}scale(e){return g.create({x:this.x*e,y:this.y*e})}toPairString(){return`${this.x},${this.y}`}isZero(){return this.x===0&&this.y===0}modulo(e){return g.create({x:this.x%e,y:this.y%e})}static arrayInclues(e,n){return n.some(o=>o.equals(e))}};let u=g;l(u,"up",()=>g.of(0,-1)),l(u,"upRight",()=>g.of(1,-1)),l(u,"right",()=>g.of(1,0)),l(u,"downRight",()=>g.of(1,1)),l(u,"down",()=>g.of(0,1)),l(u,"downLeft",()=>g.of(-1,1)),l(u,"left",()=>g.of(-1,0)),l(u,"upLeft",()=>g.of(-1,-1)),l(u,"zero",()=>g.of(0,0));class v extends w{constructor(){super(...arguments);l(this,"left",0);l(this,"right",0);l(this,"top",0);l(this,"bottom",0)}static of({topLeft:e,bottomRight:n}){return v.create({left:e.x,right:n.x,top:e.y,bottom:n.y})}static fromPoints(e){const n=e.map(i=>i.x),o=e.map(i=>i.y);return v.create({left:Math.min(...n),right:Math.max(...n),top:Math.min(...o),bottom:Math.max(...o)})}static fromCenter(e,n,o){return v.create({left:e.x-n,right:e.x+n,top:e.y-o,bottom:e.y+o})}scale(e){return v.create({left:this.left*e,right:this.right*e,top:this.top*e,bottom:this.bottom*e})}width(){return this.right-this.left}height(){return this.bottom-this.top}topLeft(){return u.of(this.left,this.top)}topRight(){return u.of(this.right,this.top)}bottomLeft(){return u.of(this.left,this.bottom)}bottomRight(){return u.of(this.right,this.bottom)}containsPoint(e,n=!1){return n?e.x>=this.left&&e.x<=this.right&&e.y>=this.top&&e.y<=this.bottom:e.x>=this.left&&e.x<this.right&&e.y>=this.top&&e.y<this.bottom}}const ut="rgb(0, 0, 0, .06)",ke="#047304",Lt="#444",jt={up:{type:"move",direction:"up",x:0,y:-1},down:{type:"move",direction:"down",x:0,y:1},left:{type:"move",direction:"left",x:-1,y:0},right:{type:"move",direction:"right",x:1,y:0}},qe=[u.left(),u.right(),u.up(),u.down(),u.upLeft(),u.upRight(),u.downLeft(),u.downRight()],Be=0,Ct={"#":"wall","@":"player",":":"shrubbery","!":"cactus","*":"coin","/":"rightLeanWall","\\":"leftLeanWall",O:"rock",">":"rightArrow","<":"leftArrow",X:"exit",A:"teleportDestination",T:"teleporter"},Ne={"=":"#","-":"#"},It=u.of(11,7),lt=u.of(2,2);function Fe(r,t){const{cellW:e,cellH:n,canvasW:o,canvasH:i,mapViewport:a}=t,{x:s,y:c}=t.translateAndScale(a.topLeft());at(0,i/n+1).forEach(f=>{const p=f*n+c;k({ctx:r,start:{x:0,y:p},end:{x:o,y:p},color:ut})}),at(0,o/e+1).forEach(f=>{const p=f*e+s;k({ctx:r,start:{x:p,y:0},end:{x:p,y:i},color:ut})})}function k({ctx:r,start:t,end:e,color:n,width:o=1}){r.strokeStyle=n,r.lineWidth=1,r.beginPath(),r.moveTo(t.x,t.y),r.lineTo(e.x,e.y),r.stroke()}async function We(){const r=[["rock","assets/rock.svg"],["arrow","assets/arrow.svg"],["player","assets/player.svg"],["cactus","assets/bomb.svg"],["shrubbery","assets/shrub.svg"],["wall","assets/wallTexture.png"],["coin","assets/coin.svg"],["exit","assets/exit.svg"],["teleporter","assets/teleporter.svg"],["teleportDestination","assets/teleportDestination.svg"]],t=await Promise.all(r.map(([e,n])=>{const o=new Image;return o.src=n,new Promise(i=>{o.onload=()=>i({[e]:o})})}));return D((e,n)=>({...e,...n}),{},t)}const _e=(r,t,e,n)=>{const{x:o,y:i,width:a,height:s}=t.translateAndScale(n);r.drawImage(e,o,i,a,s)};function $e(r,t,e,n){const{color:o}=n;r.fillStyle=o;const{x:i,y:a,width:s,height:c}=t.translateAndScale(n);r.fillRect(i,a,s,c),r.drawImage(e.wall,i,a,s,c)}function Ve(r,t,e,n){const o=.3333333333333333,{x:i,y:a,width:s,height:c}=t.translateAndScale(n);r.drawImage(e.arrow,i,a+c*(.5-o/2),s,c*o)}function ze(r,t,e,n){const{x:o,y:i,width:a,height:s}=t.translateAndScale(n);r.save(),r.scale(-1,1),r.drawImage(e.arrow,-o-a,i+s/3,a,s/3),r.restore()}function De(r,t,e,n){const{x:o,y:i,width:a,height:s}=t.translateAndScale(n);r.drawImage(Qe(n.spriteType,a,e.wall),o,i,a,s)}function Qe(r,t,e){const n=document.createElement("canvas");n.width=t,n.height=t;const o=n.getContext("2d");o.fillStyle=Lt,o.translate(t/2,t/2),o.rotate(r==="leftLeanWall"?-Math.PI/4:Math.PI/4),o.translate(-t/2,-t/2);const i=t*3/8,a=t/4;return o.fillRect(i,-50,a,t+300),o.drawImage(e,i,-50,a,t+300),o.restore(),n}const Ue=(r,t,e)=>{const{color:n,char:o}=e;r.fillStyle=n;const{x:i,y:a,width:s,height:c}=t.translateAndScale(e);r.fillRect(i,a,s,c),r.font=`${s}px serif`,r.textAlign="center",r.fillStyle="#DDD",r.fillText(o,i+s*.5,a+c*.85)},Xe=(r,t)=>{r.fillStyle=ke;const{clippedCanvasViewport:e}=t;r.fillRect(e.left,e.top,e.width(),e.height())};function Ge(r,t,e,n){r.fillStyle="rgba(0,0,0,0.5)",r.fillRect(0,0,t.width,t.height),r.fillStyle="white",r.textAlign="center",r.font="48px serif",r.fillText("Game Over",t.width/2,t.height/2),r.font="24px serif",r.fillText(e,t.width/2,t.height/2+30),r.font="24px serif",r.fillText(`score: ${n}`,t.width/2,t.height/2+60)}function He(r,t,e,n){r.fillStyle="rgba(0,0,0,0.5)",r.fillRect(0,0,t.width,t.height),r.fillStyle="white",r.textAlign="center",r.font="48px serif",r.fillText(`Level ${e}`,t.width/2,t.height/2),r.font="24px serif",r.fillText(n,t.width/2,t.height/2+50),r.fillText("press spacebar to start",t.width/2,t.height/2+80)}function Ye({ctx:r,canvas:t,score:e,maxScore:n,moves:o,maxMoves:i}){r.fillStyle="rgba(0,0,0,0.5)",r.fillRect(0,0,t.width,t.height),r.fillStyle="white",r.textAlign="center",r.font="48px serif",r.fillText("Level Complete",t.width/2,t.height/2),r.font="24px serif",r.fillText(`score: ${e} / ${n}`,t.width/2,t.height/2+30),r.fillText(`moves: ${o} / ${i}`,t.width/2,t.height/2+60),r.fillText("press spacebar for next level, esc to try for a better score",t.width/2,t.height/2+90)}function Ze(r,t){r.fillStyle="rgba(0,0,0,0.15)",r.fillRect(0,0,t.width,t.height),r.fillStyle="white",r.textAlign="center",r.font="12px serif",r.fillText("working...",t.width/2,20)}function Ke(r,t){const{clippedCanvasViewport:e,mapBounds:n}=t,o=t.translateAndScale(n.topLeft()),i=t.translateAndScale(n.bottomRight()),a=u.of(i.x,o.y),s=u.of(o.x,i.y),c=[{start:o,end:a},{start:s,end:i}],f=[{start:o,end:s},{start:a,end:i}],p={ctx:r,bounds:e,color:"black",width:5};c.forEach(m=>Je({...m,...p})),f.forEach(m=>tr({...m,...p}))}function Je({ctx:r,start:t,end:e,bounds:n,color:o,width:i}){if(t.y!==e.y)throw new Error("start and end must have same y");if(t.y<n.top||t.y>n.bottom)return;const a=u.of(Math.max(t.x,n.left),t.y),s=u.of(Math.min(e.x,n.right),e.y);k({ctx:r,start:a,end:s,color:o,width:i})}function tr({ctx:r,start:t,end:e,bounds:n,color:o,width:i}){if(t.x!==e.x)throw new Error("start and end must have same x");if(t.x<n.left||t.x>n.right)return;const a=u.of(t.x,Math.max(t.y,n.top)),s=u.of(t.x,Math.min(e.y,n.bottom));k({ctx:r,start:a,end:s,color:o,width:i})}const S=[],ct={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",w:"up",s:"down",a:"left",d:"right",h:"left",j:"down",k:"up",l:"right",Escape:"restart","-":"zoomOut",_:"zoomOut","=":"zoomIn","+":"zoomIn"," ":"space"};function er(){window.addEventListener("keydown",r=>{S.forEach(t=>{t("keydown",r)})}),window.addEventListener("keyup",r=>{S.forEach(t=>{t("keyup",r)})}),window.addEventListener("keypress",r=>{S.forEach(t=>{t("keypress",r)})})}function rr(r){return S.push(r),()=>{const t=S.indexOf(r);S.splice(t,1)}}const nr=r=>(t,e)=>{t!=="keypress"&&ct[e.key]&&r(t,ct[e.key])};class Q extends w{constructor(){super(...arguments);l(this,"sprites",[])}static fromSprites(e){const[[n],o]=Ee(i=>i.spriteType==="player",e);return Q.create({sprites:[n,...o]})}getAt(e){return this.sprites.find(n=>u.of(n).equals(e))}updateAt(e,n){return this.copy({sprites:this.sprites.map(o=>u.of(o).equals(e)?n:o)})}getPlayer(){return this.sprites[0]}move(e,n){const o=this.getAt(e);if(!o)throw console.error("No sprite found at: ",e),new Error(`No sprite found at ${e.toString()}`);const i=o.moveTo(n);return this.copy({sprites:this.sprites.map(a=>u.of(a).equals(e)?i:a)})}moveAndUpdate(e,n){if(!this.getAt(e))throw console.error("No sprite found at: ",e),new Error(`No sprite found at ${e.toString()}`);return this.copy({sprites:this.sprites.map(i=>u.of(i).equals(e)?n:i)})}removeAt(e){return this.copy({sprites:this.sprites.filter(n=>!u.of(n).equals(e))})}find(e){return this.sprites.find(e)}forEach(e){this.sprites.forEach(e)}getCardinalNeighbors(e){return Object.values(jt).map(n=>this.getAt(u.of(e).add(n))).filter(ot)}getAllNeighbors(e){return qe.map(n=>this.getAt(n.add(e))).filter(ot)}filterToViewport(e){return this.copy({sprites:this.sprites.filter(n=>e.containsPoint(n,!0))})}}const Rt={leftArrow:{direct:u.left(),leftLeanWall:[u.up(),u.upLeft()],rightLeanWall:[u.down(),u.downLeft()]},rightArrow:{direct:u.right(),leftLeanWall:[u.down(),u.downRight()],rightLeanWall:[u.up(),u.upRight()]},rock:{direct:u.down(),leftLeanWall:[u.right(),u.downRight()],rightLeanWall:[u.left(),u.downLeft()]}};function B(r,t){const e=Rt[t.spriteType].direct.add(t),n=r.find(o=>e.equals(o));return!n||!["leftLeanWall","rightLeanWall"].includes(n.spriteType)?n:or(r,t,n)}function or(r,t,e){return Rt[t.spriteType][e.spriteType].map(o=>o.add(t)).find(o=>r.find(i=>o.equals(i)))}class N extends w{constructor(){super(...arguments);l(this,"x",0);l(this,"y",0);l(this,"spriteType","?");l(this,"color","black");l(this,"impassible",!1);l(this,"canBeTrampled",!1);l(this,"char","?");l(this,"score",0);l(this,"death",!1);l(this,"gameOverReason","");l(this,"isMobile",!1);l(this,"allowedFlows",[u.upLeft(),u.upRight(),u.downLeft(),u.downRight()]);l(this,"drawSprite",null);l(this,"supportedBy",null);l(this,"hasMoved",!1)}static fromType(e,n,o){return N.create({x:e,y:n,spriteType:o,char:je(Ct)[o],...ir[o]})}draw(e,n,o){this.drawSprite?this.drawSprite(e,n,o,this):o[this.spriteType]?_e(e,n,o[this.spriteType],this):Ue(e,n,this)}moveTo(e){return this.copy({x:e.x,y:e.y,hasMoved:!0})}isRock(){return this.spriteType==="rock"}isArrow(){return["leftArrow","rightArrow"].includes(this.spriteType)}isPlayer(){return this.spriteType==="player"}hasSupport(e){return this.supportedBy&&e.getAt(this.supportedBy)}setSupport(e){return this.copy({supportedBy:B(e,this)})}}const _={color:Lt,impassible:!0,allowedFlows:[],drawSprite:De},ft={isMobile:!0,allowedFlows:[]},ir={wall:{..._,drawSprite:$e},leftLeanWall:{..._,allowedFlows:[u.upLeft(),u.downRight()]},rightLeanWall:{..._,allowedFlows:[u.upRight(),u.downLeft()]},shrubbery:{canBeTrampled:!0,score:0,allowedFlows:[]},cactus:{death:!0,gameOverReason:"You got too close to a bomb!",allowedFlows:[]},coin:{canBeTrampled:!0,score:10},rock:{isMobile:!0},leftArrow:{...ft,drawSprite:Ve},rightArrow:{...ft,drawSprite:ze},exit:{allowedFlows:[]}};class U extends N{constructor(){super(...arguments);l(this,"color","red");l(this,"spriteType","player");l(this,"score",0);l(this,"char","P");l(this,"moves",0)}static from(e,n){return U.create({x:e,y:n})}addScore(e){return this.copy({score:this.score+e})}draw(e,n,o){ar(e,n,o,this)}moveTo(e){return this.copy({x:e.x,y:e.y,moves:this.moves+1})}}function ar(r,t,e,n){const{x:i,y:a,width:s,height:c}=t.translateAndScale(n);r.strokeStyle="white",r.strokeRect(i,a,s,c),r.drawImage(e.player,i+s*(.5-.65/2),a,s*.65,c)}class X extends w{constructor(){super(...arguments);l(this,"sprites",[]);l(this,"maxScore",0);l(this,"comment","");l(this,"maxMoves",0);l(this,"bounds",null)}static parse(e){const n=e.trim().split(`
`),o=sr(n),i=n.length-2,a=n[0].length,s=v.create({left:0,top:0,right:a,bottom:i});return X.create({maxScore:o.reduce((c,f)=>c+f.score,0),sprites:o,bounds:s,comment:n.at(-2),maxMoves:n.at(-1)})}}const sr=xt(r=>r.slice(0,r.length-2),r=>r.map((t,e)=>t.split("").map((n,o)=>lr(o,e,n))),Me,z(r=>r!==null),ur);function ur(r){return r.map(t=>{if(!t.isMobile)return t;const e=B(r,t);return e?t.copy({supportedBy:u.of(e)}):t})}function lr(r,t,e){const n=Ne[e],o=Ct[n||e];return o?o==="player"?U.from(r,t):N.fromType(r,t,o):null}const cr=String.raw`
=======================\OOO*OOOO/#OO####
*O       O:#         O/ \OOOOOO/# ::A**#
# O #### #:#       **/   \OOOO/   ######
# #  O  *#:#              \OO/   ##    -
# #* * ###:# OOO           O/    ##    -
# ######:::#*****         :/  *###* O  -
#    #*                 @     *<*###*< -
#*#! ###                  \   *###*    -
###              !     ::  \     ##    -
# #          \ /=O=   ::::   \O     / O/
#*           O O  =    ::   / \*   / */-
###         #***# =        /   \    O/ -
X < !!!     #\*/# =       /    O*O*O*O -
>*   *   *<  # #  =      /     =**O*O= -
    !!!   ! !# #! =! \    /    =:O*O:= -
          ! *#T#*:::::\**/     =::::::*-
Unplug the Cistern #1
1000
`.trim(),fr=String.raw`
##############
#*@ **** ** X#
##############
Collect diamonds for a high score!
1000
`.trim(),pr=String.raw`
##############
#   *::: ** ##
#*@ *:*: ** *#
#   *::: ** X#
##############
Trample shrubbery to get to more diamonds!
1000
`.trim(),hr=String.raw`
##############
#     :   T#*#
# @  :*:  ##AX
##############
Use the teleporter to get to the exit!
1000
`.trim(),dr=String.raw`
#############################################################
#@#:::::::::#:::#:::::::::#:::#:#:#:::#:::#:#:#:::::::#:#:::#
#:###:#:#:###:#####:#####:###:#:#:#:#:###:#:#:###:#####:###:#
#:::#:#:#:#:#:::::::#:::::::#:::::::#:#:::#:::::::::::::::::#
###:#####:#:#####:#######:#####:#:#:#:###:#:#####:###:#:###:#
#::*::::::#::*::::#:#::::*::::::#:#:#:#:#:::#:::::#:::#:#:::#
#:#:#:#####:#:#####:#####:###:#######:#:#####:#####:#:###:###
#:#:#:#:::::#:::::::#:::#:::#:#:::::#:#:::#:#:#:::#:#:::#:::#
#:#:#####:#:###:#####:#######:#:#####:###:#:#:#:###:#:#:#####
#:#:::::::#:#:::::#:::::#:#:::::::#:#:#:#:::::#:::#:#:#:::::#
#:###:###:###:###:#:#:#:#:#:#####:#:###:#:#####:###:#:#:###:#
#:#:::::#:#:::::#:#:#:#:#:#:::#::*::::::::#:::#:::#:#:#:::#:#
#:#####:#########:#:###:#:#######:#:###:#####:#:#:#####:#####
#:::#:::#:::::#:::#:::#:::::::#:::#:::#:::#:#:#:#:::::#:#:::#
###########:#######:###:#######:###:#:#:###:#:#######:###:###
#:#:#:::::::::::#:::::#:#:::#:::#:::#:#:::#:#:#:::::::#:#:::#
#:#:###:#:###:#####:#:#####:#########:#####:#:#:#######:#:#:#
#:::::::#:#:::::#:::#:::#:#:#:::#:::#*:::::::::*::::::::#:#:#
###:#####:#:###:#:#####:#:#:###:#:#:#:#########:###:###:#:###
#:::::#:::#:::#:#:#:::::#:::#:::#:#:#:#:::#:::::::#:::#:#:#:#
#####:#:#######:#:#####:#:###:#:###:#:###:#####:#:#:###:#:#:#
#:::::#:#:::#:::::::#:::::::#:#:#:::::::#:::::::#:#:#:#:#:::#
###:#:#####:#:#############:###:###:###########:#####:###:###
#:::#:::#:::#:::#:::#:::::::#:#:::::::::::::#::*::::#:::::::#
#:#########:#:#:###:#####:#:#:#############:###:#:###:#:#:###
#:#:#:::#:#:#:#:#:::#:::::#:::::#:::#:::::::::#:#:::#:#:#:::#
#:#:#:###:#:#:###:#########:#:#:#:###:#:###:#######:#####:###
#:::::::#:::::::#:#:#:#:::::#:#:::#:::#:::#:#:::::::#:#:::::#
#####:###:#######:#:#:#:#:#:###:#####:###########:#:#:#####:#
#:::::::#:#:::#:#:::#:::#:#:::#:#:::::#::::::::*::#:#:#:#:#:#
#:###:###:###:#:#:#:###:###########:###:#:#####:#####:#:#:#:#
#:#:#:#:#:::::::#:#:#:::::::::::::#:#:#:#:#:#::*::::::::::::#
###:###:#######:###:#:#:#:###:###:#:#:###:#:###:#########:###
#:#:#:#:::::::#:::#:#:#:#:#:::#:::#:::#:#:::::#:#:::#:::#:#:#
#:#:#:#:#:#####:###:###:#########:#:#:#:###:###:#:#####:###:#
#:::#:#:#:::::::::::#:#:#:#:::#:::::#:#:::#:::#:#:::::::#:::#
#:###:#:###:###:#####:###:#:#:#:###:#:#:#######:###:#####:###
#:#:::::#:::#:::::::#:::#:::#:::#:::#:::::::::#::::*::#:::::#
#:#######:#:###:#:###:#####:###:#####:#############:#:#:#:###
#:::::::::#:::#:#:::::#:::::#:::::#:::::#:::::::::::#:::#:*X#
#############################################################
Maze with breadcrumbs! (generated at www.dcode.fr)
1000
`.trim(),gr=String.raw`
###OOOOOOOOO##########
#@ *************** X##
#### # # # # #########
Watch out for falling rocks!
1000
`.trim(),yr=String.raw`
##############
#    *O* ** !#
# @  *!* *! *#
#    *** *!! X
##############
Don't get too close to bombs!
1000
`.trim(),mr=String.raw`
##############
#*  *<>: ** ##
#*@ *:*: ** *X
##############
Watch out for flying arrows!
1000
`.trim(),wr=String.raw`
###############
#O  #O :O#** ##
# @ #\* / *# *#
#*  O     *##X#
#####   #######
More fun with rocks!
1000
`.trim(),vr=String.raw`
##############
#\OOOO/      #
#@\OO/       #
#  \O        #
#   \*       #
#            #
#    \       #
#     \      #
#       /    #
#      /     #
#     /      #
#   \        #
#####\       #
#   # \      #
#   #   /  *X#
#   #        #
#   #        #
#   #        #
#   #        #
##############
Rock Slide!
1000
`.trim(),Or=String.raw`
#########O*#
#   O/>*  ##
#@> /:*:  *#
#*  *:::  X#
############
More fun with arrows!
1000
`.trim(),$=[{name:"intro-1",map:fr},{name:"intro-2",map:pr},{name:"intro-3",map:hr},{name:"intro-4",map:dr},{name:"intro-5",map:gr},{name:"intro-6",map:yr},{name:"intro-7",map:mr},{name:"intro-8",map:wr},{name:"intro-9",map:vr},{name:"intro-10",map:Or},{name:"wanderer-1",map:cr}],Ar=(r,t,e,n)=>({x:o,y:i})=>({x:Math.floor((o-r.x-.5)*t+n.x),y:Math.floor((i-r.y-.5)*e+n.y),width:t,height:e});class L extends w{constructor(){super(...arguments);l(this,"canvas",null);l(this,"mapBounds",null);l(this,"canvasCenter",null);l(this,"mapViewCenter",null);l(this,"cellW",0);l(this,"cellH",0);l(this,"canvasW",0);l(this,"canvasH",0);l(this,"canvasViewport",null);l(this,"mapViewport",null);l(this,"clippedCanvasViewport",null);l(this,"_translateAndScale",null);l(this,"zoom",null)}static buildOnCenter(e,n,o,i){const a=Et(e),s=Sr(e,o),c=br(e,s),f=Tr(c,s,i),p=Ar(i,s,s,a),m=v.fromPoints([p({x:Math.max(0,f.left),y:Math.max(0,f.top)}),p({x:Math.min(n.width(),f.right+1),y:Math.min(n.height(),f.bottom+1)})]);return L.create({canvas:e,mapBounds:n,canvasCenter:a,mapViewCenter:i,cellW:s,cellH:s,canvasW:e.width,canvasH:e.height,canvasViewport:c,mapViewport:f,clippedCanvasViewport:m,_translateAndScale:p,zoom:o})}recenter(e){return L.buildOnCenter(this.canvas,this.mapBounds,this.zoom,e)}zoomTo(e){return L.buildOnCenter(this.canvas,this.mapBounds,e,this.mapViewCenter)}translateAndScale(e){return this._translateAndScale(e)}}const Et=r=>u.of(Math.round(r.width/2),Math.round(r.height/2)),Sr=(r,t=It)=>{const e=Math.floor(r.width/t.x),n=Math.floor(r.height/t.y);return Math.min(e,n)},br=(r,t)=>{const e=Math.floor(t/2),n=Et(r).subtract(u.of(e,e)).modulo(t);return v.create({left:n.x,top:n.y,right:n.x+t*Math.floor((r.width-n.x)/t),bottom:n.y+t*Math.floor((r.height-n.y)/t)})},Tr=(r,t,e)=>v.fromCenter(e,Math.floor(.5*r.width()/t),Math.floor(.5*r.height()/t));class C extends w{constructor(){super(...arguments);l(this,"setState",null);l(this,"mapData",null);l(this,"sprites",null);l(this,"canvas",null);l(this,"ctx",null);l(this,"projection",null);l(this,"mapBounds",null);l(this,"gameOver",!1);l(this,"levelComplete",!1);l(this,"levelStart",!0);l(this,"gameOverReason","");l(this,"animateQueue",[]);l(this,"assets",null);l(this,"levelName",0);l(this,"levelComplete",!1);l(this,"levelComment","");l(this,"maxScore",0);l(this,"zoom",null);l(this,"levelNumber",0);l(this,"movedSprites",[])}static initialize(e,n,o,i){console.log("Levels: ",$),console.log("Level Number: ",n);const{name:a,map:s}=$[n],c=X.parse(s),{sprites:f,bounds:p,maxScore:m,comment:b}=c,I=Q.fromSprites(f),G=It,kt=L.buildOnCenter(o,p,G,I.getPlayer());return C.create({setState:e,mapData:c,mapBounds:p,levelName:a,sprites:I,canvas:o,ctx:o.getContext("2d"),projection:kt,assets:i,maxScore:m,levelComment:b,zoom:G,levelNumber:n})}}function xr({setState:r,oldState:t,newPlayer:e,collidingSprite:n,command:o}){if(["up","down"].includes(o.direction))return t;const{sprites:i}=t,a=u.of(n).add(o);if(i.getAt(a))return t;const s=i.move(n,a).move(i.getPlayer(),e),c=n.moveTo(a).setSupport(s);return t.copy({sprites:s.updateAt(a,c),movedSprites:[i.getPlayer(),n],animateQueue:[...t.animateQueue,c]})}function Mr(r,t){const e=u.of(0,1),n=u.of(-1,1),o=u.of(1,1),i=r.getAt(e.add(t));if(!i||i.isPlayer())return e;const a=r.getAt(n.add(t));if((!a||a.isPlayer())&&!r.getAt(u.left().add(t))&&u.arrayInclues(n,i.allowedFlows))return n;const s=r.getAt(o.add(t));return(!s||s.isPlayer())&&!r.getAt(u.right().add(t))&&u.arrayInclues(o,i.allowedFlows)?o:!1}function Lr(r,t){r(e=>{const{sprites:n,animateQueue:o,mapBounds:i}=e,a=Mr(n,t),s=o.filter(p=>!p.equals(t));if(!a||!i.containsPoint(a.add(t)))return e.copy({animateQueue:s,sprites:n.updateAt(t,t.copy({supportedBy:B(n,t)}))});if(t.hasSupport(n))return e.copy({animateQueue:s});const c=u.of(t).add(a),f=t.moveTo(c);return c.equals(n.getPlayer())?e.copy({movedSprites:[t],animateQueue:s,gameOver:!0,gameOverReason:"You were bonked by a rock"}):e.copy({movedSprites:[t],sprites:n.move(t,c),animateQueue:Mt([f],s)})})}function jr({setState:r,oldState:t,newPlayer:e,collidingSprite:n,command:o}){if(["left","right"].includes(o.direction))return t;const{sprites:i}=t,a=u.of(n).add(o);if(i.getAt(a))return t;const s=i.move(n,a).move(i.getPlayer(),e),c=n.moveTo(a).setSupport(s);return t.copy({sprites:s.updateAt(a,c),movedSprites:[i.getPlayer(),n],animateQueue:[...t.animateQueue,c]})}function Cr(r,t){const e=t.spriteType==="leftArrow"?u.left():u.right(),n=e.add(u.up()),o=e.add(u.down()),i=r.getAt(e.add(t));if(!i||i.isPlayer())return e;const a=r.getAt(n.add(t));if((!a||a.isPlayer())&&!r.getAt(u.up().add(t))&&u.arrayInclues(n,i.allowedFlows))return n;const s=r.getAt(o.add(t));return(!s||s.isPlayer())&&!r.getAt(u.down().add(t))&&u.arrayInclues(o,i.allowedFlows)?o:!1}function pt(r,t){r(e=>{const{sprites:n,animateQueue:o,mapBounds:i}=e,a=Cr(n,t),s=o.filter(p=>!p.equals(t));if(!a||!i.containsPoint(a.add(t)))return e.copy({animateQueue:s,sprites:n.updateAt(t,t.copy({supportedBy:B(n,t)}))});if(t.hasSupport(n))return e.copy({animateQueue:s});const c=u.of(t).add(a),f=t.moveTo(c);return c.equals(n.getPlayer())?e.copy({movedSprites:[t],animateQueue:s,gameOver:!0,gameOverReason:"You were poked by a arrow"}):e.copy({sprites:n.move(t,c),movedSprites:[t],animateQueue:Mt([f],s)})})}function Ir(r,t,e){const{sprites:n,gameOver:o,animateQueue:i,mapBounds:a}=r,s=n.getPlayer();if(o||i.length>0)return r;const c=s.moveTo(u.of(s).add(e));if(!a.containsPoint(c))return r;const f=n.getAt(c);if(f&&f.spriteType==="exit")return r.copy({levelComplete:!0,movedSprites:[s],sprites:n.move(s,c)});if(f&&f.spriteType==="teleporter"){const p=n.find(m=>m.spriteType==="teleportDestination");return r.copy({projection:r.projection.recenter(p),movedSprites:[s],sprites:n.move(s,p)})}return f&&f.impassible?r:f&&f.canBeTrampled?r.copy({sprites:n.removeAt(c).moveAndUpdate(s,c.addScore(f.score)),movedSprites:[s,f]}):f&&f.death?r.copy({movedSprites:[s,f],gameOver:!0,gameOverReason:f.gameOverReason,sprites:n.move(s,c)}):f&&f.isRock()?xr({setState:t,oldState:r,newPlayer:c,collidingSprite:f,command:e}):f&&f.isArrow()?jr({setState:t,oldState:r,newPlayer:c,collidingSprite:f,command:e}):r.copy({movedSprites:[s],sprites:n.move(s,c)})}async function Rr(r,t,e){const n=await We();let o;const i=a=>{o=xt(a,qr(),Pr(o),kr())(o),ht(o),t.textContent=o.sprites.getPlayer().score,_r(o)};o=C.initialize(i,0,r,n),er(),ht(o),rr(nr(Er(i))),e.onclick=Pt(i)}function ht({sprites:r,canvas:t,ctx:e,projection:n,levelName:o,gameOver:i,mapData:a,levelComplete:s,levelStart:c,gameOverReason:f,assets:p,animateQueue:m}){const b=r.getPlayer();e.reset(),Xe(e,n),Fe(e,n),r.filterToViewport(n.mapViewport).forEach(I=>I.draw(e,n,p)),m.length>0&&Ze(e,t),i&&Ge(e,t,f,b.score),s&&Ye({ctx:e,canvas:t,score:b.score,maxScore:a.maxScore,moves:b.moves,maxMoves:a.maxMoves}),c&&He(e,t,o,a.comment),Ke(e,n)}const Pt=r=>()=>{r(t=>C.initialize(r,t.levelNumber,t.canvas,t.assets))},Er=r=>(t,e)=>{if(t!=="keydown")return;const n=jt[e],o=()=>r(a=>a.levelStart?a.copy({levelStart:!1}):a.copy(Ir(a,r,n)));({restart:Pt(r),up:o,down:o,left:o,right:o,zoomIn:gt(r,lt.scale(-1)),zoomOut:gt(r,lt),space:Wr(r)})[e]()},Pr=r=>t=>{const{sprites:e,mapBounds:n}=t;return n.containsPoint(e.getPlayer())?t:r},kr=r=>t=>{const{sprites:e,projection:n}=t,o=e.getPlayer(),i=n.mapViewport;return o.x-i.left<1||i.right-o.x<1||o.y-i.top<1||i.bottom-o.y<1?t.copy({projection:n.recenter(o)}):t},qr=r=>t=>{const{sprites:e,movedSprites:n,animateQueue:o}=t,i=n.flatMap(s=>s.spriteType==="player"?Br(e,s).concat(dt(e,s)):dt(e,s)),a=[...o,...i];return t.copy({animateQueue:a,movedSprites:[]})};function Br(r,t){return r.getCardinalNeighbors(t).filter(Nr(r)).map(e=>e.copy({supportedBy:null}))}function dt(r,t){return r.getAllNeighbors(t).filter(Fr(r,t)).map(e=>e.copy({supportedBy:null}))}const Nr=r=>t=>!t.isMobile||t.spriteType==="player"?!1:!t.supportedBy||!r.getAt(t.supportedBy),Fr=(r,t)=>e=>e.supportedBy&&u.of(t).equals(e.supportedBy)&&!r.getAt(t),gt=(r,t)=>()=>{r(e=>{const n=e.zoom.add(t);return n.x<=7||n.y<=5?e:e.copy({zoom:n,projection:e.projection.zoomTo(n)})})},Wr=r=>()=>{r(t=>t.levelStart?t.copy({levelStart:!1}):t.levelComplete&&$.length>t.levelNumber+1?C.initialize(r,t.levelNumber+1,t.canvas,t.assets):t)};function _r(r){r.animateQueue.length>0&&setTimeout(()=>$r(r.setState,r.animateQueue),Be)}function $r(r,t){if(t.length===0)return;const e=t[0];({rock:Lr,leftArrow:pt,rightArrow:pt})[e.spriteType](r,e)}function Vr(){const r=document.querySelector("#restart"),t=document.getElementById("score"),e=document.querySelector("canvas");e.width=e.clientWidth,e.height=e.clientHeight,Rr(e,t,r)}Vr();
